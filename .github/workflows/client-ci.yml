name: Client CI

on:
  push:
  workflow_dispatch:

concurrency:
  group: client-ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate:
    name: Validate Client
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "yarn"

      - name: Enable Corepack + Yarn 4
        run: |
          corepack enable
          corepack prepare yarn@4.12.0 --activate
          corepack yarn --version

      - name: Install dependencies (immutable)
        run: corepack yarn install --immutable

      - name: Stamp package version (CI only)
        run: |
          node <<'NODE'
          const fs = require("node:fs");
          const packageJsonPath = "package.json";
          const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, "utf8"));
          const baseVersion = String(packageJson.version || "0.0.0").split("-")[0].split("+")[0];
          const runNumber = process.env.GITHUB_RUN_NUMBER || "0";
          const shortSha = (process.env.GITHUB_SHA || "local").slice(0, 7).toLowerCase();
          const stampedVersion = `${baseVersion}-ci.${runNumber}.${shortSha}`;
          packageJson.version = stampedVersion;
          fs.writeFileSync(packageJsonPath, `${JSON.stringify(packageJson, null, 2)}\n`);
          console.log(`Stamped package.json version: ${stampedVersion}`);
          NODE

      - name: Build
        run: corepack yarn build
